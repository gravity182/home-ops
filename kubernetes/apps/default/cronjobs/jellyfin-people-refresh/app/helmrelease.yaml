---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: jellyfin-people-refresh
spec:
  chartRef:
    kind: OCIRepository
    name: jellyfin-people-refresh
  interval: 1h
  values:
    controllers:
      jellyfin:
        type: cronjob
        cronjob:
          schedule: "0 3 * * *"
          concurrencyPolicy: Replace
          successfulJobsHistory: 3
          failedJobsHistory: 1
        pod:
          restartPolicy: OnFailure
        containers:
          app:
            image:
              repository: python
              tag: 3.14-alpine@sha256:31da4cb527055e4e3d7e9e006dffe9329f84ebea79eaca0a1f1c27ce61e40ca5
            command: ["python", "/scripts/refresh_people.py"]
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 10m
                memory: 64Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        fsGroupChangePolicy: OnRootMismatch
    persistence:
      scripts:
        enabled: true
        type: configMap
        name: jellyfin-people-refresh-script
        defaultMode: 0775
        globalMounts:
          - path: /scripts
            readOnly: true
      config:
        enabled: true
        type: configMap
        name: jellyfin-people-refresh-config
        defaultMode: 0775
        globalMounts:
          - path: /config
            readOnly: true
      secrets:
        enabled: true
        type: secret
        name: jellyfin-people-refresh-api
        defaultMode: 0440
        globalMounts:
          - path: /secrets
            readOnly: true
      tmp:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /tmp

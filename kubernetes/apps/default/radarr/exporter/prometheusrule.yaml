---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: radarr-rules
spec:
  groups:
    - name: radarr.rules
      labels:
        namespace: default
        app: radarr
      rules:
        - alert: RadarrSystemStatusNotOK
          expr: radarr_system_status{job="radarr-exporter"} != 1
          for: 10m
          labels:
            severity: critical
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr system unhealthy
            description: >-
              radarr_system_status is {{ $value }} (expected 1). Check Radarr UI → System → Status.

        - alert: RadarrHealthIssuesWarning
          expr: >-
            sum without (message, source, type, wikiurl) (radarr_system_health_issues{job="radarr-exporter", type!="error"}) > 0
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr health issues present
            description: >-
              Radarr reports {{ $value }} non-error health issue(s).

        - alert: RadarrHealthIssuesCritical
          expr: >-
            sum without (message, source, wikiurl) (radarr_system_health_issues{job="radarr-exporter", type="error"}) > 0
          for: 1h
          labels:
            severity: critical
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr health errors present
            description: >-
              Radarr reports {{ $value }} health error(s).

        - alert: RadarrExporterScrape5xx
          expr: >-
            increase(radarr_scrape_requests_total{job="radarr-exporter", code=~"5.."}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr exporter sees 5xx from Radarr API
            description: >-
              HTTP 5xx responses from Radarr API in the last 15m: {{ $value }}.

        - alert: RadarrExporterUnauthorized
          expr: >-
            increase(radarr_scrape_requests_total{job="radarr-exporter", code=~"401|403"}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr exporter unauthorized (401/403)
            description: >-
              Radarr exporter received HTTP 401/403 from Radarr API in the last 15m: {{ $value }}. Check API key / auth settings.

        - alert: RadarrExporterScrapeSlow
          expr: radarr_scrape_duration_seconds{job="radarr-exporter"} > 20
          for: 10m
          labels:
            severity: warning
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr exporter scrapes are slow
            description: >-
              Last Radarr exporter scrape took {{ $value | humanizeDuration }} (timeout is 30s).

        - alert: RadarrBacklogForTwoWeeks
          expr: >-
            max without (__name__) (
              (radarr_movie_missing_total{job="radarr-exporter"} > 0)
              or (radarr_movie_wanted_total{job="radarr-exporter"} > 0)
              or (radarr_movie_cutoff_unmet_total{job="radarr-exporter"} > 0)
            ) > 0
          for: 14d
          labels:
            severity: info
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Radarr backlog non-zero for 14 days
            description: >-
              Radarr reports a non-empty backlog for 14 days (missing/wanted/cutoff unmet).

        - alert: RadarrDiskSpaceLowWarning
          expr: radarr_rootfolder_freespace_bytes{job="radarr-exporter"} < (100 * 1024 * 1024 * 1024)
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Low disk space for Radarr storage
            description: >-
              {{ $labels.job }} {{ if $labels.path }}(path {{ $labels.path }}){{ end }} has only {{ $value | humanize1024 }} free (threshold 100GiB).

        - alert: RadarrDiskSpaceLowCritical
          expr: radarr_rootfolder_freespace_bytes{job="radarr-exporter"} < (20 * 1024 * 1024 * 1024)
          for: 15m
          labels:
            severity: critical
            component: media-management
            app: radarr
          annotations:
            summary: >-
              Critically low disk space for Radarr storage
            description: >-
              {{ $labels.job }} {{ if $labels.path }}(path {{ $labels.path }}){{ end }} has only {{ $value | humanize1024 }} free (threshold 20GiB).

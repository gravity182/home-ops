---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: metrics-exporters-bazarr-rules
spec:
  groups:
    - name: metrics-exporters.bazarr.rules
      rules:
        - alert: BazarrSystemStatusNotOK
          expr: bazarr_system_status{job="metrics-exporters-bazarr-exporter"} != 1
          for: 10m
          labels:
            severity: critical
            component: media-management
            app: bazarr
          annotations:
            summary: >-
              Bazarr system unhealthy
            description: >-
              bazarr_system_status is {{ $value }} (expected 1). Check Bazarr UI → System → Status.

        - alert: BazarrHealthIssuesWarning
          expr: >-
            sum without (issue, object) (bazarr_system_health_issues{job="metrics-exporters-bazarr-exporter"}) > 0
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: bazarr
          annotations:
            summary: >-
              Bazarr health issues present
            description: >-
              Bazarr reports {{ $value }} health issue(s).

        - alert: BazarrExporterScrape5xx
          expr: >-
            increase(bazarr_scrape_requests_total{job="metrics-exporters-bazarr-exporter", code=~"5.."}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: bazarr
          annotations:
            summary: >-
              Bazarr exporter sees 5xx from Bazarr API
            description: >-
              HTTP 5xx responses from Bazarr API in the last 15m: {{ $value }}.

        - alert: BazarrExporterUnauthorized
          expr: >-
            increase(bazarr_scrape_requests_total{job="metrics-exporters-bazarr-exporter", code=~"401|403"}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: bazarr
          annotations:
            summary: >-
              Bazarr exporter unauthorized (401/403)
            description: >-
              Bazarr exporter received HTTP 401/403 from Bazarr API in the last 15m: {{ $value }}. Check API key / auth settings.

        - alert: BazarrExporterScrapeSlow
          expr: bazarr_scrape_duration_seconds{job="metrics-exporters-bazarr-exporter"} > 20
          for: 10m
          labels:
            severity: warning
            component: media-management
            app: bazarr
          annotations:
            summary: >-
              Bazarr exporter scrapes are slow
            description: >-
              Last Bazarr exporter scrape took {{ $value | humanizeDuration }} (timeout is 30s).

        - alert: BazarrBacklogForTwoWeeks
          expr: >-
            max without (__name__) (
              (bazarr_subtitles_missing_total{job="metrics-exporters-bazarr-exporter"} > 0)
              or (bazarr_subtitles_wanted_total{job="metrics-exporters-bazarr-exporter"} > 0)
            ) > 0
          for: 14d
          labels:
            severity: info
            component: media-management
            app: bazarr
          annotations:
            summary: >-
              Bazarr backlog non-zero for 14 days
            description: >-
              Bazarr reports missing/wanted subtitles for 14 days.

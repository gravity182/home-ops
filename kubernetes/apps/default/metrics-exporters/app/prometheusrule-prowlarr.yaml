---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: metrics-exporters-prowlarr-rules
spec:
  groups:
    - name: metrics-exporters.prowlarr.rules
      rules:
        - alert: ProwlarrSystemStatusNotOK
          expr: prowlarr_system_status{job="metrics-exporters-prowlarr-exporter"} != 1
          for: 10m
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr system unhealthy
            description: >-
              prowlarr_system_status is {{ $value }} (expected 1). Check Prowlarr UI → System → Status.

        - alert: ProwlarrHealthIssuesWarning
          expr: >-
            sum without (message, source, type, wikiurl) (prowlarr_system_health_issues{job="metrics-exporters-prowlarr-exporter", type!="error"}) > 0
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr health issues present
            description: >-
              Prowlarr reports {{ $value }} non-error health issue(s).

        - alert: ProwlarrHealthIssuesCritical
          expr: >-
            sum without (message, source, wikiurl) (prowlarr_system_health_issues{job="metrics-exporters-prowlarr-exporter", type="error"}) > 0
          for: 1h
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr health errors present
            description: >-
              Prowlarr reports {{ $value }} health error(s).

        - alert: ProwlarrNoEnabledIndexers
          expr: prowlarr_indexer_enabled_total{job="metrics-exporters-prowlarr-exporter"} < 1
          for: 10m
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr has no enabled indexers
            description: >-
              Enabled indexer count is {{ $value }} (expected >= 1).

        - alert: ProwlarrIndexerLatencyHigh
          expr: >-
            max_over_time(prowlarr_indexer_average_response_time_ms{job="metrics-exporters-prowlarr-exporter"}[15m]) > 15000
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexer latency is high
            description: >-
              Max indexer average response time in the last 15m: {{ $value | humanizeDuration }}.

        - alert: ProwlarrIndexerLatencyVeryHigh
          expr: >-
            max_over_time(prowlarr_indexer_average_response_time_ms{job="metrics-exporters-prowlarr-exporter"}[15m]) > 30000
          for: 30m
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexer latency is very high
            description: >-
              Max indexer average response time in the last 15m: {{ $value | humanizeDuration }}.

        - alert: ProwlarrVipExpiring
          expr: >-
            max by (indexer) (prowlarr_indexer_vip_expires_in_seconds{job="metrics-exporters-prowlarr-exporter"}) < (30 * 24 * 60 * 60)
            and max by (indexer) (prowlarr_indexer_vip_expires_in_seconds{job="metrics-exporters-prowlarr-exporter"}) > 0
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr VIP expiring soon
            description: >-
              VIP for indexer {{ $labels.indexer }} expires in {{ $value | humanizeDuration }} (threshold 30d).

        - alert: ProwlarrVipExpired
          expr: >-
            max by (indexer) (prowlarr_indexer_vip_expires_in_seconds{job="metrics-exporters-prowlarr-exporter"}) <= 0
          for: 1h
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr VIP expired
            description: >-
              VIP for indexer {{ $labels.indexer }} is expired (expires_in_seconds={{ $value }}).

        - alert: ProwlarrIndexerHighFailureRate
          expr: >-
            (
              sum(clamp_min(delta(prowlarr_indexer_failed_queries_total{job="metrics-exporters-prowlarr-exporter"}[15m]), 0))
              /
              clamp_min(sum(clamp_min(delta(prowlarr_indexer_queries_total{job="metrics-exporters-prowlarr-exporter"}[15m]), 0)), 1)
            ) > 0.3
            and sum(clamp_min(delta(prowlarr_indexer_queries_total{job="metrics-exporters-prowlarr-exporter"}[15m]), 0)) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexer failure rate > 30%
            description: >-
              Failed/total query ratio over 15m is {{ $value | humanizePercentage }} (threshold 30%).

        - alert: ProwlarrExporterScrape5xx
          expr: >-
            increase(prowlarr_scrape_requests_total{job="metrics-exporters-prowlarr-exporter", code=~"5.."}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr exporter sees 5xx from Prowlarr API
            description: >-
              HTTP 5xx responses from Prowlarr API in the last 15m: {{ $value }}.

        - alert: ProwlarrExporterUnauthorized
          expr: >-
            increase(prowlarr_scrape_requests_total{job="metrics-exporters-prowlarr-exporter", code=~"401|403"}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr exporter unauthorized (401/403)
            description: >-
              Prowlarr exporter received HTTP 401/403 from Prowlarr API in the last 15m: {{ $value }}. Check API key / auth settings.

        - alert: ProwlarrExporterScrapeSlow
          expr: prowlarr_scrape_duration_seconds{job="metrics-exporters-prowlarr-exporter"} > 20
          for: 10m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr exporter scrapes are slow
            description: >-
              Last Prowlarr exporter scrape took {{ $value | humanizeDuration }} (timeout is 30s).

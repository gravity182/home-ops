---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: metrics-exporters-qbittorrent-rules
spec:
  groups:
    - name: metrics-exporters.qbittorrent.rules
      rules:
        - alert: QbittorrentNotConnected
          expr: qbittorrent_transfer_connection_status{job="metrics-exporters-qbittorrent-exporter", connection_status!="connected"} == 1
          for: 10m
          labels:
            severity: critical
            component: media-management
            app: qbittorrent
          annotations:
            summary: >-
              qBittorrent is not connected (firewalled/disconnected)
            description: >-
              qBittorrent connection status is {{ $labels.connection_status }}.

        - alert: QbittorrentTorrentsInError
          expr: qbittorrent_torrent_states{job="metrics-exporters-qbittorrent-exporter", name="error"} > 0
          for: 15m
          labels:
            severity: critical
            component: media-management
            app: qbittorrent
          annotations:
            summary: >-
              qBittorrent has torrents in error state
            description: >-
              Number of torrents in error state: {{ $value }}.

        - alert: QbittorrentMissingFiles
          expr: qbittorrent_torrent_states{job="metrics-exporters-qbittorrent-exporter", name="missingFiles"} > 0
          for: 15m
          labels:
            severity: critical
            component: media-management
            app: qbittorrent
          annotations:
            summary: >-
              qBittorrent has torrents with missing files
            description: >-
              Number of torrents with missing files: {{ $value }}.

        - alert: QbittorrentNoPeers
          expr: >-
            qbittorrent_global_total_peer_connections{job="metrics-exporters-qbittorrent-exporter"} == 0
            and on (job) (
              sum without (name) (
                qbittorrent_torrent_states{
                  job="metrics-exporters-qbittorrent-exporter",
                  name=~"downloading|uploading|stalledDL|stalledUP|queuedDL|queuedUP|forcedDL|forcedUP"
                }
              ) > 0
            )
            and on (job) qbittorrent_transfer_connection_status{job="metrics-exporters-qbittorrent-exporter", connection_status="connected"} == 1
          for: 15m
          labels:
            severity: warning
            component: media-management
            app: qbittorrent
          annotations:
            summary: >-
              qBittorrent has no peer connections
            description: >-
              Active torrent activity detected but peer connections are 0. Check firewall/NAT/VPN/port-forwarding.

        - alert: QbittorrentStalledDownloads
          expr: qbittorrent_torrent_states{job="metrics-exporters-qbittorrent-exporter", name="stalledDL"} > 0
          for: 2h
          labels:
            severity: info
            component: media-management
            app: qbittorrent
          annotations:
            summary: >-
              qBittorrent has stalled downloads
            description: >-
              Number of torrents in stalledDL state: {{ $value }}.

        - alert: QbittorrentDhtNodesZero
          expr: >-
            qbittorrent_global_dht_nodes{job="metrics-exporters-qbittorrent-exporter"} == 0
            and on (job) qbittorrent_transfer_connection_status{job="metrics-exporters-qbittorrent-exporter", connection_status="connected"} == 1
            and on (job) qbittorrent_torrent_states{job="metrics-exporters-qbittorrent-exporter", name=~"downloading|stalledDL|queuedDL|metaDL"} > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: qbittorrent
          annotations:
            summary: >-
              qBittorrent DHT nodes is zero
            description: >-
              qBittorrent reports 0 DHT nodes while connected and download activity is present. Check firewall/NAT/VPN/DHT settings.

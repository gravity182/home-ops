---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: prowlarr-rules
spec:
  groups:
    - name: prowlarr.rules
      labels:
        namespace: default
        app: prowlarr
      rules:
        - alert: ProwlarrSystemStatusNotOK
          expr: prowlarr_system_status{job="prowlarr-exporter"} != 1
          for: 10m
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr system unhealthy
            description: >-
              prowlarr_system_status is {{ $value }} (expected 1). Check Prowlarr UI → System → Status.

        - alert: ProwlarrHealthIssuesWarning
          expr: >-
            sum without (message, source, type, wikiurl) (prowlarr_system_health_issues{job="prowlarr-exporter", type!="error"}) > 0
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr health issues present
            description: >-
              Prowlarr reports {{ $value }} non-error health issue(s).

        - alert: ProwlarrHealthIssuesCritical
          expr: >-
            sum without (message, source, wikiurl) (prowlarr_system_health_issues{job="prowlarr-exporter", type="error"}) > 0
          for: 1h
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr health errors present
            description: >-
              Prowlarr reports {{ $value }} health error(s).

        - alert: ProwlarrNoIndexersEnabled
          expr: prowlarr_indexer_enabled_total{job="prowlarr-exporter"} < 1
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              No indexers enabled in Prowlarr
            description: >-
              Prowlarr has no enabled indexers.

        - alert: ProwlarrIndexersSlowWarning
          expr: >-
            max_over_time(prowlarr_indexer_average_response_time_ms{job="prowlarr-exporter"}[15m]) > 15000
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexers are slow
            description: >-
              Prowlarr indexer response time exceeded 15s in the last 15m.

        - alert: ProwlarrIndexersSlowCritical
          expr: >-
            max_over_time(prowlarr_indexer_average_response_time_ms{job="prowlarr-exporter"}[15m]) > 30000
          for: 30m
          labels:
            severity: critical
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexers are very slow
            description: >-
              Prowlarr indexer response time exceeded 30s in the last 15m.

        - alert: ProwlarrIndexerVipExpiringSoon
          expr: >-
            max by (indexer) (prowlarr_indexer_vip_expires_in_seconds{job="prowlarr-exporter"}) < (30 * 24 * 60 * 60)
            and max by (indexer) (prowlarr_indexer_vip_expires_in_seconds{job="prowlarr-exporter"}) > 0
          for: 6h
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexer VIP expiring soon
            description: >-
              Indexer {{ $labels.indexer }} VIP expires in less than 30 days.

        - alert: ProwlarrIndexerVipExpired
          expr: >-
            max by (indexer) (prowlarr_indexer_vip_expires_in_seconds{job="prowlarr-exporter"}) <= 0
          for: 1h
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexer VIP expired
            description: >-
              Indexer {{ $labels.indexer }} VIP has expired.

        - alert: ProwlarrIndexerFailureRateHigh
          expr: >-
            clamp_min(sum(clamp_min(delta(prowlarr_indexer_failed_queries_total{job="prowlarr-exporter"}[15m]), 0)), 0)
              /
            clamp_min(sum(clamp_min(delta(prowlarr_indexer_queries_total{job="prowlarr-exporter"}[15m]), 0)), 1)
            > 0.5
            and sum(clamp_min(delta(prowlarr_indexer_queries_total{job="prowlarr-exporter"}[15m]), 0)) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr indexer failure rate high
            description: >-
              More than 50% of indexer queries are failing in the last 15m.

        - alert: ProwlarrExporterScrape5xx
          expr: >-
            increase(prowlarr_scrape_requests_total{job="prowlarr-exporter", code=~"5.."}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr exporter sees 5xx from Prowlarr API
            description: >-
              HTTP 5xx responses from Prowlarr API in the last 15m: {{ $value }}.

        - alert: ProwlarrExporterUnauthorized
          expr: >-
            increase(prowlarr_scrape_requests_total{job="prowlarr-exporter", code=~"401|403"}[15m]) > 0
          for: 30m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr exporter unauthorized (401/403)
            description: >-
              Prowlarr exporter received HTTP 401/403 from Prowlarr API in the last 15m: {{ $value }}. Check API key / auth settings.

        - alert: ProwlarrExporterScrapeSlow
          expr: prowlarr_scrape_duration_seconds{job="prowlarr-exporter"} > 20
          for: 10m
          labels:
            severity: warning
            component: media-management
            app: prowlarr
          annotations:
            summary: >-
              Prowlarr exporter scrapes are slow
            description: >-
              Last Prowlarr exporter scrape took {{ $value | humanizeDuration }} (timeout is 30s).
